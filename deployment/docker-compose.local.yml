name: aurorah
services:
    hm-aurorah-minio:
        image: minio/minio:latest
        container_name: hm-aurorah-minio
        restart: always
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            start_period: 5s
            interval: 300s
            timeout: 1s
            retries: 5
        ports:
            - "9000:9000" # API
            - "9001:9001" # Console
        env_file:
            - .env.minio
        command: server /data --console-address ":9001"
        volumes:
            - minio-data:/data
        networks:
            - main-network
    hm-aurorah-redis:
        image: redis:latest
        container_name: hm-aurorah-redis
        restart: always
        # NOTE: Commented out because vm.overcommit_memory sysctl requires host kernel access,
        # which isn't allowed in Docker-in-Docker or restricted container runtimes.
        # privileged: true
        # sysctls:
        #     # vm.overcommit_memory=1 tells Linux to always allow memory allocation requests, even if physical memory is low.
        #     # Redis needs this because it forks a child process for background saves (RDB/AOF), which temporarily requires double the memory.
        #     # Without this setting, the fork can fail if memory appears low.
        #     - vm.overcommit_memory=1
        healthcheck:
            test: redis-cli ping
            start_period: 5s
            interval: 300s
            timeout: 1s
            retries: 5
        ports:
            - "6379:6379"
        volumes:
            - redis-data:/data
        networks:
            - main-network
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "10"
    hm-aurorah-postgres:
        image: postgres:latest
        container_name: hm-aurorah-postgres
        restart: always
        ports:
            - "5432:5432"
        env_file:
            - .env.postgres
        volumes:
            - postgres-data:/var/lib/postgresql
        healthcheck:
            test: pg_isready -U postgres
            start_period: 5s
            timeout: 1s
            retries: 5
            interval: 300s
        networks:
            - main-network
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "10"
        command: >
            bash -c "
                docker-entrypoint.sh postgres &
                until pg_isready -U postgres; do sleep 1; done
                psql -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'aurorah'\" | grep -q 1 || psql -U postgres -c 'CREATE DATABASE aurorah;'
                psql -U postgres -d aurorah -c 'CREATE SCHEMA IF NOT EXISTS auth;'
                psql -U postgres -d aurorah -c 'CREATE SCHEMA IF NOT EXISTS lang;'
                wait
            "
    hm-aurorah-api:
        image: hm-aurorah-api
        container_name: hm-aurorah-api
        restart: always
        ports:
            - 33001:33001
        working_dir: /home
        entrypoint: /bin/sh
        command:
            - -c
            - |
                NUM_OF_CPUS=$$(nproc --all)
                NUM_OF_WORKERS=$((NUM_OF_CPUS * 2 + 1))
                echo "CPUs: $$NUM_OF_CPUS, Workers: $$NUM_OF_WORKERS"
                uvicorn app.main:app --host 0.0.0.0 --port 33001 --workers $$NUM_OF_WORKERS
        env_file:
            - .env.local
        networks:
            - main-network
        depends_on:
            hm-aurorah-minio:
                condition: service_healthy
            hm-aurorah-redis:
                condition: service_healthy
            hm-aurorah-postgres:
                condition: service_healthy
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
                max-file: "10"
networks:
    main-network:
        name: aurorah_main_network
volumes:
    postgres-data:
        driver: local
        name: aurorah_postgres_data
    redis-data:
        driver: local
        name: aurorah_redis_data
    minio-data:
        driver: local
        name: aurorah_minio_data
