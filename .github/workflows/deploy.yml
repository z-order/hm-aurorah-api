# This is a basic workflow to help you get started with Actions

name: Deploy to AWS EC2 Aurora Dev Server

# Controls when the workflow will run
on:
    # Triggers the workflow on push or pull request events but only for the "main" branch
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

# Permissions
permissions:
    id-token: write # for GitHub Actions OIDC
    contents: read # for reading the code

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
    deploy:
        name: Deploy to Host
        runs-on: ubuntu-latest
        environment:
            name: ${{ github.ref == 'refs/heads/main' && 'AWS-EC2-DEVELOPMENT' || github.ref == 'refs/heads/production' && 'AWS-EC2-PRODUCTION' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # SSH key authentication (deprecated) -> This way has the issues on setting AWS security groups and firewall rules for the GitHub Action IPs (https://api.github.com/meta)
            # - name: Setup SSH key
            #   run: |
            #       mkdir -p ~/.ssh
            #       echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
            #       chmod 600 ~/.ssh/id_rsa

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-oidc-role
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Verify AWS Login
              run: aws sts get-caller-identity

            - name: Setup SSH via AWS Systems Manager
              run: |
                  mkdir -p ~/.ssh
                  ssh-keygen -t rsa -b 2048 -N '' -f ~/.ssh/id_rsa -q
                  aws ec2-instance-connect send-ssh-public-key \
                    --instance-id ${{ secrets.INSTANCE_ID }} \
                    --availability-zone ${{ secrets.AVAILABILITY_ZONE }} \
                    --instance-os-user ${{ secrets.USERNAME }} \
                    --ssh-public-key file://~/.ssh/id_rsa.pub

            - name: Add host to known_hosts
              run: |
                  ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

            - name: Rsync files to host
              run: |
                  rsync -avz --delete ./ ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ secrets.DEST }}

            - name: Create .env file on remote host
              run: |
                  ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} "cd ${{ secrets.DEST }} && cat > .env.${{ vars.DEPLOY_ENV || 'production' }} << 'EOF'
                  API_KEY1=${{ secrets.API_KEY1 }}
                  API_KEY2=${{ secrets.API_KEY2 }}
                  API_KEY3=${{ secrets.API_KEY3 }}
                  API_KEY4=${{ secrets.API_KEY4 }}
                  API_KEY5=${{ secrets.API_KEY5 }}
                  API_KEY6=${{ secrets.API_KEY6 }}
                  API_KEY7=${{ secrets.API_KEY7 }}
                  API_KEY8=${{ secrets.API_KEY8 }}
                  API_KEY9=${{ secrets.API_KEY9 }}
                  REDIS_URL=${{ vars.REDIS_URL }}
                  POSTGRES_URL=${{ secrets.POSTGRES_URL }}
                  LANGGRAPH_API_URL=${{ vars.LANGGRAPH_API_URL }}
                  EOF
                  "

            - name: Run remote deploy script
              run: |
                  ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} "cd ${{ secrets.DEST }} && bash -l -c './deployment/deploy.sh ${{ vars.DEPLOY_ENV || 'production' }} api'"
